# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set Plugin
# Copyright (c) 2021-2022 Core Rule Set project. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# IP-Monitor Plugin
# Plugin name: ipmanagement
# Plugin description: Allow dynamically adding/removing an IP from a managementing list
#   All requests from IPs in managementing list will be logged (even if they don't trigger
#   other rules)
# Rule ID block base: 9,500,000 (range is 1000, thus ID block base +1000)
# Plugin version: 0.0.1

# This plugin initialises the IP collection to be just the IP (not with appended
#   user-agent. This behaviour is essential for this plugin to work as expected.
#   Plugin must run before IP collection is initialised elsewhere (eg. CRS 901321)
# Changing IP collection from CRS 901321:
#     initcol:ip=%{remote_addr}_%{tx.ua_hash}
#   to:
#     initcol:ip=%{remote_addr}
#   means that CRS (and any other IP based rules), may have reduced granularity
#     as User-Agent will not be used to try and distringuish between multiple
#     users/clients coming from the same IP.


# Generic rule to disable plugin
SecRule TX:ipmanagement-plugin_enabled "@eq 0" "id:9500090,phase:1,pass,nolog,ctl:ruleRemoveById=9500100-9500999"



##############################
### ADMIN SECURITY CHECKS ####
##############################

# Skip admin rules if not from an authorised IP
SecRule &TX:ipmanagement-plugin_auth_ip "@gt 0" "id:9500100,phase:1,pass,nolog,skipAfter:END-IP-MANAGEMENT-PLUGIN-ADMIN,chain"
	SecRule REMOTE_ADDR "!@within %{tx.ipmanagement-plugin_auth_ip}" 

# Skip admin rules if not an authorised User-Agent
SecRule &TX:ipmanagement-plugin_auth_user_agent "@gt 0" "id:9500110,phase:1,pass,nolog,skipAfter:END-IP-MANAGEMENT-PLUGIN-ADMIN,chain"
	SecRule REQUEST_HEADERS:User-Agent "!@streq %{tx.ipmanagement-plugin_auth_user_agent}"




#############################
### START OF ADMIN RULES ####
#############################

######################################
### START OF TRACKING ADMIN RULES ####
######################################
# rule 9,500,200 : Administrative - Add IP to track list
SecRule REQUEST_URI "@rx ^(.*)/track/add/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$" \
	"id:9500200,\
	phase:1,\
	deny,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Add IP:%{TX.1} to TRACK list',\
	logdata:'ip-management ADD %{TX.2} TRACK',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL',\
	setvar:'tx.9500200_baseuri=%{TX.1}',\
	setvar:'tx.9500200_ip=%{TX.2}',\
	chain"
	SecRule TX:ipmanagement-plugin_baseuri "@streq %{TX.9500200_baseuri}" \
		"initcol:ip=%{TX.9500200_ip},\
		setvar:'ip.track=1'"

# rule 9,500,250 : Administrative - Remove IP from track list
SecRule REQUEST_URI "@rx ^(.*)/track/remove/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$" \
	"id:9500250,\
	phase:1,\
	deny,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Remove IP:%{TX.1} from TRACK list',\
	logdata:'ip-management REMOVE %{TX.2} TRACK',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL',\
	setvar:'tx.9500250_baseuri=%{TX.1}',\
	setvar:'tx.9500250_ip=%{TX.2}',\
	chain"
	SecRule TX:ipmanagement-plugin_baseuri "@streq %{TX.9500250_baseuri}" \
		"initcol:ip=%{TX.9500250_ip},\
		setvar:'!ip.track=1'"

####################################
### END OF TRACKING ADMIN RULES ####
####################################





##########################################
### START OF DENY LISTING ADMIN RULES ####
##########################################
# rule 9,500,300 : Administrative - Add IP to deny list
SecRule REQUEST_URI "@rx ^(.*)/deny/add/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$" \
	"id:9500300,\
	phase:1,\
	deny,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Add IP:%{TX.1} to DENY list',\
	logdata:'ip-management ADD %{TX.2} DENY',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL',\
	setvar:'tx.9500300_baseuri=%{TX.1}',\
	setvar:'tx.9500300_ip=%{TX.2}',\
	chain"
	SecRule TX:ipmanagement-plugin_baseuri "@streq %{TX.9500300_baseuri}" \
		"initcol:ip=%{TX.9500300_ip},\
		setvar:'!ip.allow=0',\
		setvar:'ip.deny=1'"

# rule 9,500,350 : Administrative - Remove IP from deny list
SecRule REQUEST_URI "@rx ^(.*)/deny/remove/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$" \
	"id:9500350,\
	phase:1,\
	deny,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Remove IP:%{TX.1} from DENY list',\
	logdata:'ip-management REMOVE %{TX.2} DENY',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL',\
	setvar:'tx.9500350_baseuri=%{TX.1}',\
	setvar:'tx.9500350_ip=%{TX.2}',\
	chain"
	SecRule TX:ipmanagement-plugin_baseuri "@streq %{TX.9500350_baseuri}" \
		"initcol:ip=%{TX.9500350_ip},\
		setvar:'!ip.deny=1'"

########################################
### END OF DENY LISTING ADMIN RULES ####
########################################





###########################################
### START OF ALLOW LISTING ADMIN RULES ####
###########################################
# rule 9,500,400 : Administrative - Add IP to allow list
SecRule REQUEST_URI "@rx ^(.*)/allow/add/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$" \
	"id:9500400,\
	phase:1,\
	deny,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Add IP:%{TX.1} to ALLOW list',\
	logdata:'ip-management ADD %{TX.2} ALLOW',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL',\
	setvar:'tx.9500400_baseuri=%{TX.1}',\
	setvar:'tx.9500400_ip=%{TX.2}',\
	chain"
	SecRule TX:ipmanagement-plugin_baseuri "@streq %{TX.9500400_baseuri}" \
		"initcol:ip=%{TX.9500400_ip},\
		setvar:'!ip.deny=0',\
		setvar:'ip.allow=1'"

# rule 9,500,450 : Administrative - Remove IP from allow list
SecRule REQUEST_URI "@rx ^(.*)/allow/remove/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$" \
	"id:9500450,\
	phase:1,\
	deny,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Remove IP:%{TX.1} from ALLOW list',\
	logdata:'ip-management REMOVE %{TX.2} ALLOW',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL',\
	setvar:'tx.9500450_baseuri=%{TX.1}',\
	setvar:'tx.9500450_ip=%{TX.2}',\
	chain"
	SecRule TX:ipmanagement-plugin_baseuri "@streq %{TX.9500450_baseuri}" \
		"initcol:ip=%{TX.9500450_ip},\
		setvar:'!ip.allow=1'"

#########################################
### END OF ALLOW LISTING ADMIN RULES ####
#########################################






###########################
### END OF ADMIN RULES ####
###########################
SecMarker END-IP-MANAGEMENT-PLUGIN-ADMIN





#######################################
### Intialise IP Collection with IP ###
#######################################
# rule 9,500,500 Skip IP collection initialisation if none of the following variables are set to greater than 0:
#   TX:ipmanagement-plugin_enable-tracking
#   TX:ipmanagement-plugin_enable-allow-listing
#   TX:ipmanagement-plugin_enable-deny-listing
# Note if variables do not exist IP collection initialisation will happen

SecRule TX:ipmanagement-plugin_enable-tracking "!@gt 0" "id:9500500,phase:1,pass,nolog,skipAfter:END-IP-MANAGEMENT-PLUGIN-IPINIT,chain"
	SecRule TX:ipmanagement-plugin_enable-allow-listing "!@gt 0" "chain"
		SecRule TX:ipmanagement-plugin_enable-deny-listing "!@gt 0"

SecAction \
    "id:9500510,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'ip-management-plugin/0.0.1',\
    initcol:ip=%{remote_addr},\
    setvar:'tx.real_ip=%{remote_addr}'"
SecMarker END-IP-MANAGEMENT-PLUGIN-IPINIT

###########################################
### END Intialise IP Collection with IP ###
###########################################




################################
### START OF TRACKING RULES ####
################################
SecRule TX:ipmanagement-plugin_enable-tracking "!@gt 0" "id:9500600,phase:1,pass,nolog,skipAfter:END-IP-MANAGEMENT-PLUGIN-TRACKING"

# rule 9,500,610
SecRule IP:TRACK "@ge 1" \
	"id:9500610,\
	phase:1,\
	pass,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Tracking IP:%{tx.real_ip}',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL'"

SecMarker END-IP-MANAGEMENT-PLUGIN-TRACKING
##############################
### END OF TRACKING RULES ####
##############################




####################################
### START OF DENY LISTING RULES ####
####################################
SecRule TX:ipmanagement-plugin_enable-deny-listing "!@gt 0" "id:9500700,phase:1,pass,nolog,skipAfter:END-IP-MANAGEMENT-PLUGIN-DENY-LISTING"

# rule 9,500,710
SecRule IP:DENY "@ge 1" \
	"id:9500710,\
	phase:1,\
	deny,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Blocking IP:%{tx.real_ip}',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL'"


SecMarker END-IP-MANAGEMENT-PLUGIN-DENY-LISTING
##################################
### END OF DENY LISTING RULES ####
##################################




#####################################
### START OF ALLOW LISTING RULES ####
#####################################
SecRule TX:ipmanagement-plugin_enable-allow-listing "!@gt 0" "id:9500800,phase:1,pass,nolog,skipAfter:END-IP-MANAGEMENT-PLUGIN-ALLOW-LISTING"

# rule 9,500,810
SecRule IP:ALLOW "@ge 1" \
	"id:9500810,\
	phase:1,\
	allow,\
	log,auditlog,\
        capture,\
	t:none,\
	msg:'Allowing IP:%{tx.real_ip}',\
        ver:'ip-management-plugin/0.0.1',\
	severity:'CRITICAL'"


SecMarker END-IP-MANAGEMENT-PLUGIN-ALLOW-LISTING
###################################
### END OF ALLOW LISTING RULES ####
###################################







